package score

import (
	"fmt"

	"github.com/build-flow-labs/blueprint/pbom/schema"
)

// scoreVulnerability grades the security posture of produced artifacts.
//
// Scoring:
//   - No artifacts: 50 (can't assess)
//   - Artifacts but no vulnerability scan: 50 (unknown risk)
//   - Scanned, zero critical+high: 100
//   - Each critical: -20
//   - Each high: -10
//   - Each medium: -3
//   - Low: no penalty
//   - Build failed: -5 (may not have been scanned properly)
func scoreVulnerability(pbom *schema.PBOM) schema.AxisScore {
	if len(pbom.Artifacts) == 0 {
		return schema.AxisScore{
			Grade:    "D",
			Score:    50,
			Findings: []string{"no artifacts to assess"},
		}
	}

	// Check if any artifact has vulnerability data
	hasVulnData := false
	totalCritical := 0
	totalHigh := 0
	totalMedium := 0
	totalLow := 0

	for _, a := range pbom.Artifacts {
		if a.Vulnerabilities != nil {
			hasVulnData = true
			totalCritical += a.Vulnerabilities.Critical
			totalHigh += a.Vulnerabilities.High
			totalMedium += a.Vulnerabilities.Medium
			totalLow += a.Vulnerabilities.Low
		}
	}

	if !hasVulnData {
		return schema.AxisScore{
			Grade:    "D",
			Score:    50,
			Findings: []string{"no vulnerability scan data available"},
		}
	}

	points := 100
	var findings []string

	if totalCritical > 0 {
		penalty := totalCritical * 20
		points -= penalty
		findings = append(findings, fmt.Sprintf("%d critical CVE(s) found", totalCritical))
	}

	if totalHigh > 0 {
		penalty := totalHigh * 10
		points -= penalty
		findings = append(findings, fmt.Sprintf("%d high CVE(s) found", totalHigh))
	}

	if totalMedium > 0 {
		penalty := totalMedium * 3
		points -= penalty
		findings = append(findings, fmt.Sprintf("%d medium CVE(s) found", totalMedium))
	}

	if totalLow > 0 {
		findings = append(findings, fmt.Sprintf("%d low CVE(s) found (no penalty)", totalLow))
	}

	if totalCritical == 0 && totalHigh == 0 && totalMedium == 0 {
		findings = append(findings, "clean scan — no critical, high, or medium CVEs")
	}

	if pbom.Build.Status == "failure" {
		points -= 5
		findings = append(findings, "build failed — scan may be incomplete")
	}

	if points < 0 {
		points = 0
	}

	return schema.AxisScore{
		Grade:    numericToGrade(points),
		Score:    points,
		Findings: findings,
	}
}
