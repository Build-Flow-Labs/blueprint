package webhook

import (
	"testing"
)

func TestCountVulnerabilities(t *testing.T) {
	tests := []struct {
		name         string
		report       TrivyReport
		wantCritical int
		wantHigh     int
		wantMedium   int
		wantLow      int
	}{
		{
			name: "mixed severities",
			report: TrivyReport{
				Results: []TrivyResult{
					{
						Target: "alpine:3.18",
						Vulnerabilities: []TrivyVulnerability{
							{VulnerabilityID: "CVE-2024-0001", Severity: "CRITICAL"},
							{VulnerabilityID: "CVE-2024-0002", Severity: "HIGH"},
							{VulnerabilityID: "CVE-2024-0003", Severity: "HIGH"},
							{VulnerabilityID: "CVE-2024-0004", Severity: "MEDIUM"},
							{VulnerabilityID: "CVE-2024-0005", Severity: "LOW"},
							{VulnerabilityID: "CVE-2024-0006", Severity: "LOW"},
							{VulnerabilityID: "CVE-2024-0007", Severity: "LOW"},
						},
					},
				},
			},
			wantCritical: 1,
			wantHigh:     2,
			wantMedium:   1,
			wantLow:      3,
		},
		{
			name: "clean scan",
			report: TrivyReport{
				Results: []TrivyResult{
					{
						Target:          "alpine:3.18",
						Vulnerabilities: nil,
					},
				},
			},
			wantCritical: 0,
			wantHigh:     0,
			wantMedium:   0,
			wantLow:      0,
		},
		{
			name:         "empty results",
			report:       TrivyReport{Results: nil},
			wantCritical: 0,
			wantHigh:     0,
			wantMedium:   0,
			wantLow:      0,
		},
		{
			name: "multiple scan targets",
			report: TrivyReport{
				Results: []TrivyResult{
					{
						Target: "os-packages",
						Vulnerabilities: []TrivyVulnerability{
							{VulnerabilityID: "CVE-2024-0001", Severity: "CRITICAL"},
						},
					},
					{
						Target: "go-modules",
						Vulnerabilities: []TrivyVulnerability{
							{VulnerabilityID: "CVE-2024-0010", Severity: "HIGH"},
							{VulnerabilityID: "CVE-2024-0011", Severity: "CRITICAL"},
						},
					},
				},
			},
			wantCritical: 2,
			wantHigh:     1,
			wantMedium:   0,
			wantLow:      0,
		},
		{
			name: "case insensitive severity",
			report: TrivyReport{
				Results: []TrivyResult{
					{
						Target: "test",
						Vulnerabilities: []TrivyVulnerability{
							{VulnerabilityID: "CVE-2024-0001", Severity: "Critical"},
							{VulnerabilityID: "CVE-2024-0002", Severity: "high"},
							{VulnerabilityID: "CVE-2024-0003", Severity: "Medium"},
							{VulnerabilityID: "CVE-2024-0004", Severity: "low"},
						},
					},
				},
			},
			wantCritical: 1,
			wantHigh:     1,
			wantMedium:   1,
			wantLow:      1,
		},
		{
			name: "unknown severity ignored",
			report: TrivyReport{
				Results: []TrivyResult{
					{
						Target: "test",
						Vulnerabilities: []TrivyVulnerability{
							{VulnerabilityID: "CVE-2024-0001", Severity: "UNKNOWN"},
							{VulnerabilityID: "CVE-2024-0002", Severity: ""},
							{VulnerabilityID: "CVE-2024-0003", Severity: "HIGH"},
						},
					},
				},
			},
			wantCritical: 0,
			wantHigh:     1,
			wantMedium:   0,
			wantLow:      0,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got := countVulnerabilities(&tt.report)
			if got.Critical != tt.wantCritical {
				t.Errorf("Critical = %d, want %d", got.Critical, tt.wantCritical)
			}
			if got.High != tt.wantHigh {
				t.Errorf("High = %d, want %d", got.High, tt.wantHigh)
			}
			if got.Medium != tt.wantMedium {
				t.Errorf("Medium = %d, want %d", got.Medium, tt.wantMedium)
			}
			if got.Low != tt.wantLow {
				t.Errorf("Low = %d, want %d", got.Low, tt.wantLow)
			}
			if got.Scanner != "trivy" {
				t.Errorf("Scanner = %q, want %q", got.Scanner, "trivy")
			}
			if got.ScannedAt == nil {
				t.Error("ScannedAt should not be nil")
			}
		})
	}
}
