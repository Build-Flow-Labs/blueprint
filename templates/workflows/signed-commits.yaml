# Signed Commits Verification Workflow
# Generated by BuildGuard - Cryptographic Commit Signing
# Frameworks: SOX, FedRAMP, NIST 800-53

name: Signed Commits Check

on:
  pull_request:
    branches: [{{if .DefaultBranch}}{{.DefaultBranch}}{{else}}main{{end}}]

permissions:
  contents: read
  pull-requests: write

jobs:
  verify-signatures:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit signatures
        id: check
        run: |
          BASE_SHA="${{"{{"}}} github.event.pull_request.base.sha {{"}}"}}"
          HEAD_SHA="${{"{{"}}} github.event.pull_request.head.sha {{"}}"}}"

          echo "Checking commits from $BASE_SHA to $HEAD_SHA"

          UNSIGNED_COMMITS=""
          COMMIT_COUNT=0
          UNSIGNED_COUNT=0

          for commit in $(git rev-list $BASE_SHA..$HEAD_SHA); do
            COMMIT_COUNT=$((COMMIT_COUNT + 1))

            # Check if commit is signed (GPG or SSH)
            if ! git verify-commit $commit 2>/dev/null; then
              UNSIGNED_COUNT=$((UNSIGNED_COUNT + 1))
              SHORT_SHA=$(echo $commit | cut -c1-7)
              AUTHOR=$(git log -1 --format='%an' $commit)
              UNSIGNED_COMMITS="$UNSIGNED_COMMITS\n- $SHORT_SHA by $AUTHOR"
            fi
          done

          echo "total=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "unsigned=$UNSIGNED_COUNT" >> $GITHUB_OUTPUT

          if [ $UNSIGNED_COUNT -gt 0 ]; then
            echo "## Unsigned Commits Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$UNSIGNED_COUNT of $COMMIT_COUNT commits are not signed:" >> $GITHUB_STEP_SUMMARY
            echo -e "$UNSIGNED_COMMITS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### How to Sign Commits" >> $GITHUB_STEP_SUMMARY
            echo "1. Configure GPG: \`git config --global commit.gpgsign true\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Or use SSH signing: \`git config --global gpg.format ssh\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## All Commits Signed" >> $GITHUB_STEP_SUMMARY
            echo "All $COMMIT_COUNT commits in this PR are cryptographically signed." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Unsigned Commits Detected\n\nThis PR contains unsigned commits. All commits must be signed with GPG or SSH keys for compliance.\n\n### Quick Fix\n```bash\n# Rebase and sign all commits\ngit rebase --exec "git commit --amend --no-edit -S" HEAD~${{"{{"}}} steps.check.outputs.total {{"}}"}}\ngit push --force-with-lease\n```\n\n[Learn more about commit signing](https://docs.github.com/en/authentication/managing-commit-signature-verification)'
            })
